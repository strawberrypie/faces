# faces
## Finding Celebrity Look-alikes Using NMSW Index and Facenet Embeddings

### Промежуточный отчет

Реализован pipeline: find_sim_celebrities_debug.py

Pipeline уже готов работать с annoy/nmslib/собственной реализацией индекса. Полезно для будущих экспериментов.
Сейчас используется обученная модель Facenet.

Поиск похожего лица выполняется по датасету CelebA.

Изображения с CelebA предобрабатываются crop+scale для использования с Facenet моделью.

Полученные к текущему моменту эмбеддинги доступны по ссылке: https://yadi.sk/d/GWOOdryL3UDcqK.

Помио этого, там содержится текущий Annoy индекс для по эмбеддингам.

Индекс взят готовым: annoy/nmslib. Реализовываем HNSW. Текущая версия индекса однопоточная, планируется покрыть реализацию тестами, профилировщиком выяснить узкие места и ускорить их с помощью OpenMP.

Планируемая архитектура:

- Планируется docker compose. Первый сервис отвечает за отображение картинок, второй за поиск в индексе.
Первый сервис получает изображение, выделяет лицо (crop+scale), вычисляет embedding и передает его на второй сервис.
Второй сервис получает embedding и возвращает индексы ближайших элементов.
Первый сервис берет соответствующие полученным индексам пути и отображает ближайшие картинки.
- Изначально планировали хранить маппинг картинки-ембединги на втором сервисе, но, кажется, это плохая идея. Инициализация индекса может происходить и извне для своей задачи.
- Помимо этого, планируем реализовать свою нейросеть на quadruplets.

### Финальный отчет

Реализован свой индекс на основе алгоритма Hierarchical Navigable Small World, покрыт тестом на корректность (на 10к векторов размерности 300 результат идентичен наивному линейному индексу). Распараллеливание при помощи OpenMP сильно затруднено из-за множества общих ресурсов (множество вложенных друг в друга объектов, представляющих собой граф), поэтому от него было решено отказаться.   
Производительность индекса сравнена на Facenet эмбеддингах с `nmslib` и с алгоритмами `BallTree` и `KDTree` из `sklearn`: запросы к индексу выполняются быстрее чем в sklearn, но nmslib индекс проигрывает, скорее всего это связанно с оптимизациями вроде префетча потенциальных соседей в память по мере выполнения запроса.
![](https://i.imgur.com/XEP9ZF0.png)
![](https://i.imgur.com/iZ0jQA5.png)

Сервис по поиску знаменитостей разбит на два микросервиса: image_waiter_server — принимает на вход картинку в веб-интерфейсе и конвертирует ее в эмбеддинг, и index_search_server — микросервис с индексом.
